<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Technician Repair Form</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; }
    form {
      max-width: 1000px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    label { font-weight: bold; }
    input, select, textarea, button {
      padding: 8px;
      width: 100%;
      box-sizing: border-box;
    }
    button:not(.full-width) {
      width: auto;
    }
    .full-width { grid-column: 1 / 3; }
    fieldset {
      border: 1px solid #ccc;
      padding: 15px;
      margin-bottom: 10px;
    }
    .readonly { background-color: #f4f4f4; }
    .section-title {
      font-size: 18px;
      margin-top: 30px;
      grid-column: 1 / 3;
      border-bottom: 1px solid #ddd;
      padding-bottom: 5px;
    }
    #logout { float: right; margin-bottom: 10px; }
  </style>
  <script>
    let jobData = [];

    async function loadJobs() {
      const response = await fetch('https://ahmedabdulrazzaqmsc.github.io/rep/jobData_full.js');
      if (!response.ok) return;
      jobData = await response.json();
    }

    const USERS = {
      "Admin": "admin123",
      "Brahim Moukafih": "bm123",
      "Christophe Jongenelen": "cj123",
      "Hassan Ouchan": "ho123",
      "Marc Eyckmans": "me123",
      "Mohammed Ballafkih": "mb123",
      "Yannick Standaert": "ys123",
      "Youssef Stitou": "yst123"
    };

    function handleJobSelect(inputEl, index) {
      const selected = inputEl.value;
      const match = jobData.find(job => job.job_description === selected);
      document.getElementById("jobCode_" + index).value = match?.job_code || '';
      document.getElementById("partNumber_" + index).value = match?.part_number || '';
      document.getElementById("partDesc_" + index).value = match?.part_description || '';
      document.getElementById("labour_" + index).value = match?.labour_hours || '';
    }

    function validateLogin() {
      const name = document.getElementById("username").value;
      const pass = document.getElementById("password").value;
      if (USERS[name] === pass) {
        sessionStorage.setItem("technicianName", name);
        location.reload();
      } else {
        alert("Invalid credentials");
      }
    }

    function addJob() {
      const container = document.getElementById("jobContainer");
      const index = container.children.length + 1;
      const datalistId = "jobList_" + index;
      const options = jobData.map(j => `<option value="${j.job_description}">`).join("");
      const fieldset = document.createElement("fieldset");

      fieldset.innerHTML = `
        <legend>Job ${index}</legend>
        <label>Job Description</label>
        <input type="text" list="${datalistId}" oninput="handleJobSelect(this, ${index})">
        <datalist id="${datalistId}">${options}</datalist>
        <label>Job Code</label>
        <input type="text" id="jobCode_${index}" class="readonly" readonly>
        <label>Part Number</label>
        <input type="text" id="partNumber_${index}" class="readonly" readonly>
        <label>Part Description</label>
        <input type="text" id="partDesc_${index}" class="readonly" readonly>
        <label>Old Part Serial</label>
        <input type="text" name="old_serial_${index}">
        <label>New Part Serial</label>
        <input type="text" name="new_serial_${index}">
        <label>Quantity</label>
        <input type="text" name="quantity_${index}">
        <input type="hidden" id="labour_${index}">
      `;
      container.appendChild(fieldset);
    }

    function addAlarm() {
      const container = document.getElementById("alarmSection");
      const input = document.createElement("input");
      input.type = "text";
      input.name = "alarm" + (container.children.length + 1);
      container.appendChild(input);
    }

    function addPhoto(sectionId) {
      const container = document.getElementById(sectionId);
      const input = document.createElement("input");
      input.type = "file";
      input.name = sectionId + "_extra";
      container.appendChild(input);
    }

    function logout() {
      sessionStorage.removeItem("technicianName");
      location.reload();
    }

    window.onload = async function () {
      await loadJobs();
      const tech = sessionStorage.getItem("technicianName");
      if (!tech) {
        document.getElementById("loginSection").style.display = "block";
        document.getElementById("formSection").style.display = "none";
      } else {
        document.getElementById("loginSection").style.display = "none";
        document.getElementById("formSection").style.display = "block";
        document.getElementById("naam").value = tech;
      }
      addJob();
    }
  </script>
</head>
<body>
  <div id="loginSection">
    <label>Username:</label>
    <input type="text" id="username">
    <label>Password:</label>
    <input type="password" id="password">
    <button onclick="validateLogin()">Login</button>
  </div>

  <div id="formSection" style="display:none">
    <button id="logout" onclick="logout()">Logout</button>
    <form>
      <label for="naam">Technician</label>
      <input type="text" id="naam" readonly>

      <div class="section-title">Photos</div>
      <div id="fotos_voor">
        <label>Before Repair</label>
        <input type="file" name="before_photo">
      </div>
      <button type="button" onclick="addPhoto('fotos_voor')">Add Before Photo</button>

      <div id="fotos_na">
        <label>After Repair</label>
        <input type="file" name="after_photo">
      </div>
      <button type="button" onclick="addPhoto('fotos_na')">Add After Photo</button>

      <div class="section-title">Alarms</div>
      <div id="alarmSection"></div>
      <button type="button" onclick="addAlarm()">Add Alarm</button>

      <div class="section-title">Jobs</div>
      <div id="jobContainer"></div>
      <button type="button" onclick="addJob()">Add Job</button>
    </form>
  </div>
</body>
</html>
